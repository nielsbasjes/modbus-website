+++
title = 'Home Assistant'
weight = 10
+++

## Demonstration
This is just a simple demonstration on one possible way to get the Sunspec data from your solar inverter into Home Assistant.

Highlevel structure of this demo script:
- Kotlin script that 
  - fetches the data (using the SunSpec/Modbus Schema Toolkit) from SunSpec device
  - pushes the data into MQTT as JSon
- MQTT Broker
  - Intermediate component
- Home Assistant gets sensor data via MQTT
  - HA config proposal is generated by the script for all provided fields

> [!TIP]
> This demo has full support for all Models, Groups and Points and all repeating patterns in those as [specified by SunSpec](https://github.com/sunspec/models/tree/master/json). 
> Not just a subset, not just the common ones, ... all of them.

## Needed
To run this you'll need:
- The ability to run a Kotlin Script
  - Java 17 (or newer)
    - For my PI3 I got Zulu 17 from the [Azul download site](https://www.azul.com/downloads/?version=java-17-lts&architecture=arm-32-bit-hf&package=jdk#zulu).
  - Kotlin commandline compiler
    - https://kotlinlang.org/docs/command-line.html
- A running MQTT broker
  - I used [Mosquitto](https://mosquitto.org/) for my tests
- A Home Assistant instance ...
  - Obviously
  - Configuration is generated by the script for you

## The result
> [!Note]
> This is all fully generated from the SunSpec specification, the fields I asked for and the capabilities of the actual device.

![SunSpec in Home Assistant](/SunSpecInHomeAssistant.png?lightbox=false)

## Relevant points
- This is just a demo ... 
  - Which happens to work pretty well.

- You can rename the script but it MUST end with `.main.kts`.
  - So `Something.main.kts` works and `Something.kts` does not work.

- At startup your device and the requested fields is used to get all the needed information about the fields that are actually available.
  - The script then outputs a Home Assistant configuration YAML to the console for easier configuration for those fields.
    
> [!WARNING] 
> My SMA inverter goes into a different mode after dark and then many fields no longer return a value (i.e. field not available). 
> So this version of this script does not give the same set of fields when compared to day time. You can change that if you want.

- Most Modbus/SunSpec devices are very SLOW. 
  - Be conservative in the number of Fields you want to retrieve. Or reduce the refresh rate (to like once every 5 seconds).
    - This line `timer.scheduleAtFixedRate(timerTask, 0L, 1000L)` the `1000L` is 1 second
    
- The available fields per device differ
  - I recommend using the `showAllFieldsWithUsableValues(sunSpec)` function to determine what your device CAN provide and then only ask for what it actually has.
  
- There are a few settings you need to do.
  - The name of the device is needed because otherwise Home Assistent will show `localhost` everywhere.
    - A default name is determined from your specific device. You can overrule this using `homeAssistantDeviceName`

## The config produced
The generated config looks something like this (snippet only):
{{< notice style="blue" icon="screwdriver-wrench" title="Home Assistant config fragment" expanded="true" >}}
{{< code language="yaml" source="/code/sunspec/HomeAssistant.yaml" >}}
{{< /notice >}}

## The script
You can download the script shown below from here: [SunSpec_to_MQTT_to_HomeAssistant.main.kts](https://github.com/nielsbasjes/modbus-website/blob/main/content/code/sunspec/SunSpec_to_MQTT_to_HomeAssistant.main.kts)

{{< notice style="green" icon="screwdriver-wrench" title="SunSpec_to_MQTT_to_HomeAssistant.main.kts" expanded="true" >}}
{{< code language="kotlin" source="/code/sunspec/SunSpec_to_MQTT_to_HomeAssistant.main.kts" >}}
{{< /notice >}}
